From c3364ce7777fc29e93592c8ca67567bd67b4f476 Mon Sep 17 00:00:00 2001
From: Oliver Kiddle <okiddle@yahoo.co.uk>
Date: Sat, 24 Mar 2018 15:02:41 +0100
Subject: [PATCH] 42518, CVE-2018-1071: check bounds when copying path in
 hashcmd()

---
 ChangeLog   | 5 +++++
 Src/exec.c  | 2 +-
 Src/utils.c | 6 +++---
 3 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 9066668..30e6b14 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+2018-03-24  Oliver Kiddle  <okiddle@yahoo.co.uk>
+
+	* 42518, CVE-2018-1071: Src/exec.c, Src/utils.c:
+	check bounds when copying path in hashcmd()
+
 2017-08-27  Peter Stephenson  <p.w.stephenson@ntlworld.com>
 
 	* unposted: Config/version.mk: 5.4.2.
diff --git a/Src/exec.c b/Src/exec.c
index cd99733..336a7fd 100644
--- a/Src/exec.c
+++ b/Src/exec.c
@@ -920,7 +920,7 @@ hashcmd(char *arg0, char **pp)
     for (; *pp; pp++)
 	if (**pp == '/') {
 	    s = buf;
-	    strucpy(&s, *pp);
+	    struncpy(&s, *pp, PATH_MAX);
 	    *s++ = '/';
 	    if ((s - buf) + strlen(arg0) >= PATH_MAX)
 		continue;
diff --git a/Src/utils.c b/Src/utils.c
index 5055d69..271f55f 100644
--- a/Src/utils.c
+++ b/Src/utils.c
@@ -2283,10 +2283,10 @@ struncpy(char **s, char *t, int n)
 {
     char *u = *s;
 
-    while (n--)
-	*u++ = *t++;
+    while (n-- && (*u++ = *t++));
     *s = u;
-    *u = '\0';
+    if (n > 0) /* just one null-byte will do, unlike strncpy(3) */
+	*u = '\0';
 }
 
 /* Return the number of elements in an array of pointers. *
-- 
2.16.3

